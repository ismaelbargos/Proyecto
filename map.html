<!DOCTYPE html>
<html>
  <head>
    <title>Marker Animation</title>
    <link rel="stylesheet" href="http://openlayers.org/en/v3.15.1/css/ol.css" type="text/css">
    <script src="http://openlayers.org/en/v3.15.1/build/ol.js"></script>
  </head>
  <body>
    <div id="map" class="map"></div>
    <div id="msg" ></div>
    <button id="start-animation">Start Animation</button>
    <script>
	var ruta = null;
	var animating = false;
	var speed= 10;
	var now;
	var speedInput = document.getElementById('speed');
	var startButton = document.getElementById('start-animation');

	//dibujamos el mapa
	var view = new ol.View({
	    center: ol.proj.fromLonLat([-3.68,40]),
	    zoom: 11
	});

      	var map = new ol.Map({
        target: document.getElementById('map'),
        loadTilesWhileAnimating: true,
        view: view,
        layers: [
          new ol.layer.Tile({
            source: new ol.source.OSM()
          })
        ]
      });
	
	//Aqui obtengo la localizaci√≥n

	var geolocation = new ol.Geolocation({
		projection: view.getProjection(),
		tracking: true
	});

		// handle geolocation error.
	geolocation.on('error', function(error) {
		alert(error.message);
	});

	var accuracyFeature = new ol.Feature({
		geometry: geolocation.getAccuracyGeometry()
	});

	geolocation.on('change:accuracyGeometry', function () {
		accuracyFeature.setGeometry(geolocation.getAccuracyGeometry());
	});

	var positionFeature = new ol.Feature();
	    positionFeature.setStyle(new ol.style.Style({
	    image: new ol.style.Circle({
		radius: 6,
		fill: new ol.style.Fill({
		    color: '#3399CC'
		}),
		stroke: new ol.style.Stroke({
		    color: '#fff',
		    width: 2
		})
	    })
	}));
	
        geolocation.on('change:position', function () {
		var coordinates = geolocation.getPosition();
		var center = ol.proj.toLonLat(coordinates, map.getView().getProjection());
		map.getView().setCenter(ol.proj.fromLonLat(center));
		positionFeature.setGeometry(coordinates ? new ol.geom.Point(coordinates) : null);
        });

	geolocation.on('error', function(error) {
		alert(error.message);
	});

        new ol.layer.Vector({
            map: map,
            source: new ol.source.Vector({
                features: [accuracyFeature, positionFeature]
            })
        });
	
	//A partir de aqui trato de trazar la ruta
	var vectorSource = new ol.source.Vector();
	var vectorLayer = new ol.layer.Vector({
	  source: vectorSource
	});
	map.addLayer(vectorLayer);

	var icon_url = 
		'//cdn.rawgit.com/openlayers/ol3/master/examples/data/icon.png';
	var styles = {
	  route: new ol.style.Style({
	    stroke: new ol.style.Stroke({
	      width: 6, color: [40, 40, 40, 0.8]
	    })
	  }),
	  icon: new ol.style.Style({
	    image: new ol.style.Icon({
	      anchor: [0.5, 1],
	      src: icon_url
	    })
	  })
	};
	var points = [];
	var msg_el = document.getElementById('msg');
	var url_osrm_nearest = '//router.project-osrm.org/nearest?loc=';
	var url_osrm_route = '//router.project-osrm.org/viaroute?loc=';

	map.on('click', function(evt){
		  var clicked = evt.coordinate;

		  utils.getNearest(clicked).then(function(coord_street){
			console.info('promise', coord_street);

			utils.createFeature([coord_street[1], coord_street[0]]);
			var points_length = points.push(coord_street);

			if (points_length < 2) {
			  msg_el.innerHTML = 'Click to add another point';
			  return;
			}
			//get the route
			var point1 = points[0].join();
			var point2 = points[1].join();
			utils.json(url_osrm_route +point1+'&loc='+point2).when({
			  ready: function(response) {
				  console.info(response);

				  if (response.status != 200) {
					  msg_el.innerHTML = response.status_message;
					  return;
				  }
				  msg_el.innerHTML = 'Route added';
				  points.length = 0;
				  ruta = utils.createRoute(response.route_geometry);
			  }
			});
		  });
		});

	var utils = {
		getNearest: function(coord){
	    var coord4326 = utils.to4326(coord);
	    var lat_lon = coord4326[1] +','+ coord4326[0];
	    
	    return new Promise(function(resolve, reject) {
	      //make sure the coord is on street
	      utils.json(url_osrm_nearest + lat_lon).when({
		ready: function(response) {
		  resolve(response.mapped_coordinate);
		}
	      });
	    });
	  },
	  createFeature: function(coord) {
	    var feature = new ol.Feature({
	      type: 'place',
	      geometry: new ol.geom.Point(ol.proj.fromLonLat(coord))
	    });
	    feature.setStyle(styles.icon);
	    vectorSource.addFeature(feature);
	  },
	  createRoute: function(polyline) {
	    // route is ol.geom.LineString
	    var route = new ol.format.Polyline({
	      factor: 1e6
	    }).readGeometry(polyline, {
	      dataProjection: 'EPSG:4326',
	      featureProjection: 'EPSG:3857'
	    });
		var feature = new ol.Feature({
		  type: 'route',
		  geometry: route
		});
		feature.setStyle(styles.route);
		vectorSource.addFeature(feature);

		return route;
	  },
	  to4326: function(coord) {
	    return ol.proj.transform([
	      parseFloat(coord[0]), parseFloat(coord[1])
	    ], 'EPSG:3857', 'EPSG:4326');
	  },
	  encodeUrlXhr: function(url, data){
	    if(data && typeof(data) === 'object') {
	      var str_data = utils.toQueryString(data);
	      url += (/\?/.test(url) ? '&' : '?') + str_data;
	    }
	    return url;
	  },
	  toQueryString: function(obj){
	    return Object.keys(obj).reduce(function(a, k) {
	      a.push(
		(typeof obj[k] === 'object') ? utils.toQueryString(obj[k]) :
		encodeURIComponent(k) + '=' + encodeURIComponent(obj[k])
	      );
	      return a;
	    }, []).join('&');
	  },
	  json: function(url, data) {
	    var
	      xhr = new XMLHttpRequest(),
	      when = {},
	      onload = function() {
		if (xhr.status === 200) {
		  when.ready.call(undefined, JSON.parse(xhr.response));
		} else {
		  console.error("Status code was " + xhr.status);
		}
	      },
	      onerror = function() {
		console.error("Can't XHR " + JSON.stringify(url));
	      },
	      onprogress = function() {}
	    ;
	    url = utils.encodeUrlXhr(url, data);
	    xhr.open("GET", url, true);
	    xhr.setRequestHeader("Accept","application/json");
	    xhr.onload = onload;
	    xhr.onerror = onerror;
	    xhr.onprogress = onprogress;
	    xhr.send(null);
	    
	    return {
	      when: function(obj){
		when.ready = obj.ready;
	      }
	    };
	  }
	};


	function startAnimation() {

		var routeCoords = ruta.getCoordinates();
		var routeLength = routeCoords.length;

		var routeFeature = new ol.Feature({
			type: 'route',
			geometry: ruta
		});
		var geoMarker = new ol.Feature({
			type: 'geoMarker',
			geometry: new ol.geom.Point(routeCoords[0])
		});
		var startMarker = new ol.Feature({
			type: 'icon',
			geometry: new ol.geom.Point(routeCoords[0])
		});
		var endMarker = new ol.Feature({
			type: 'icon',
			geometry: new ol.geom.Point(routeCoords[routeLength - 1])
		});

		var styles = {
			'route': new ol.style.Style({
				stroke: new ol.style.Stroke({
					width: 6, color: [237, 212, 0, 0.8]
				})
			}),
			'icon': new ol.style.Style({
				image: new ol.style.Icon({
					anchor: [0.5, 1],
					src: 'data/icon.png'
				})
			}),
			'geoMarker': new ol.style.Style({
				image: new ol.style.Circle({
					radius: 7,
					snapToPixel: false,
					fill: new ol.style.Fill({color: 'black'}),
					stroke: new ol.style.Stroke({
						color: 'white', width: 2
					})
				})
			})
		};

		var vectorLayer = new ol.layer.Vector({
			source: new ol.source.Vector({
				features: [routeFeature, geoMarker, startMarker, endMarker]
			}),
			style: function(feature) {
				// hide geoMarker if animation is active
				if (animating && feature.get('type') === 'geoMarker') {
					return null;
				}
				return styles[feature.get('type')];
			}
		});

		map.addLayer(vectorLayer);

		console.log(map.getLayers());

		var moveFeature = function(event) {
			var vectorContext = event.vectorContext;
			var frameState = event.frameState;

			if (animating) {
				var elapsedTime = frameState.time - now;
				// here the trick to increase speed is to jump some indexes
				// on lineString coordinates
				var index = Math.round(speed * elapsedTime / 1000);

				if (index >= routeLength) {
					stopAnimation(true);
					return;
				}

				var currentPoint = new ol.geom.Point(routeCoords[index]);
				var feature = new ol.Feature(currentPoint);
				vectorContext.drawFeature(feature, styles.geoMarker);
			}
			// tell OL3 to continue the postcompose animation
			map.render();
		};

        if (animating) {
          stopAnimation(false);
        } else {
          animating = true;
          now = new Date().getTime();
          startButton.textContent = 'Cancel Animation';
          // hide geoMarker
          geoMarker.setStyle(null);
          // just in case you pan somewhere else
          map.on('postcompose', moveFeature);
          map.render();
        }
	}
	function stopAnimation(ended) {
		animating = false;
		startButton.textContent = 'Start Animation';

		// if animation cancelled set the marker at the beginning
		var coord = ended ? routeCoords[routeLength - 1] : routeCoords[0];
		/** @type {ol.geom.Point} */ (geoMarker.getGeometry())
		  .setCoordinates(coord);
		//remove listener
		map.un('postcompose', moveFeature);
	}
      startButton.addEventListener('click', startAnimation, false);
    </script>
  </body>
</html>
